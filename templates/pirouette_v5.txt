% =============================================================
%  Volume 5 — Pirouette Pivot Series
%  Header & Template (v0.3‑draft) — 2025‑06‑28
% =============================================================
%  This file seeds the new “Volume 5” branch that integrates the
%  TIRM / AKEP knowledge‑reconstruction stack.  It is deliberately
%  lightweight so downstream modules can import it as a class
%  or \input file without pulling the whole document each time.
%  Major additions over Vol‑1…4:
%   • Provenance & Uncertainty fields (Alexandria‑ready)
%   • Keyword array for graph/FAISS indexing
%   • Version‑stamped volume metadata for CI hooks
%   • Commit‑hash injection for micro‑update tracking
%   • Key‑value \moduleKV interface + optional “type” field
%   • Back‑compat macros that forward to new ones when possible
% =============================================================

\documentclass[11pt,a4paper]{article}

% -------------------------------------------------------------
% Package stack — keep minimal; modules may load their own heavy deps
% -------------------------------------------------------------
\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{graphicx}
\usepackage{xcolor}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{tcolorbox}
\tcbuselibrary{skins,breakable}
\usepackage{xparse}
\usepackage{etoolbox}
\usepackage{colortbl}

% -------------------------------------------------------------
% Volume‑level metadata (accessible via \theVolume* macros)
% -------------------------------------------------------------
\newcommand{\VolumeID}{1}
\newcommand{\VolumeTitle}{The Physical Elements}
\newcommand{\VolumeTagline}{TIRM / AKEP Integration Draft}
\newcommand{\VolumeMajorVersion}{0.1}
\newcommand{\VolumeMinorVersion}{1}      % Increment for small edits
%   Default commit hash; CI may overwrite by writing gitversion.tex
\newcommand{\VolumeCommit}{local}
%   If a gitversion.tex file exists (generated by your CI), it should
%   contain \renewcommand{\VolumeCommit}{<hash>} to override.
\IfFileExists{gitversion.tex}{\input{gitversion.tex}}{}
\newcommand{\VolumeDate}{\today}

% Convenience macro
\newcommand{\VolumeVersion}{\VolumeMajorVersion.\VolumeMinorVersion}

% -------------------------------------------------------------
% Core \module macro (8 fixed args) — retained for raw speed + b/compat
% -------------------------------------------------------------
% Args: ID, Title, Ver, Parents, Children, Provenance, Uncertainty, Keywords
\newcommand{\module}[8]{%%
  \begin{tcolorbox}[enhanced,breakable,colframe=black!70,colback=gray!5,title={\bfseries #2 — ID: #1 (v#3)}]
    \textbf{Type}: core\\
    \textbf{Parents}: #4\\
    \textbf{Children}: #5\\[2pt]
    \textbf{Provenance}: #6\\
    \textbf{Uncertainty}: #7\\[2pt]
    \textbf{Keywords}: #8
  \end{tcolorbox}}

% -------------------------------------------------------------
% Key–Value \moduleKV — ergonomic authoring & optional fields
% -------------------------------------------------------------
% Recognised keys: id,title,version,parents,children,provenance,uncertainty,keywords,type
% “type” default = core
% -------------------------------------------------------------

%  Low‑level TLs to hold values
\ExplSyntaxOn
\tl_new:N \l_pir_id_tl
\tl_new:N \l_pir_title_tl
\tl_new:N \l_pir_ver_tl
\tl_new:N \l_pir_parents_tl
\tl_new:N \l_pir_children_tl
\tl_new:N \l_pir_prov_tl
\tl_new:N \l_pir_unc_tl
\tl_new:N \l_pir_keys_tl
\tl_new:N \l_pir_type_tl

%  Key definition table
\keys_define:nn { pirouette/module }
  {
    id          .tl_set:N = \l_pir_id_tl,
    title       .tl_set:N = \l_pir_title_tl,
    version     .tl_set:N = \l_pir_ver_tl,
    parents     .tl_set:N = \l_pir_parents_tl,
    children    .tl_set:N = \l_pir_children_tl,
    provenance  .tl_set:N = \l_pir_prov_tl,
    uncertainty .tl_set:N = \l_pir_unc_tl,
    keywords    .tl_set:N = \l_pir_keys_tl,
    type        .tl_set:N = \l_pir_type_tl,
    type        .initial:n = core,
  }

% High‑level command
\NewDocumentCommand{\moduleKV}{ m }{%% #1 = key=value list
  \group_begin:
    \keys_set:nn { pirouette/module } { #1 }
    % Fallback if author omitted required fields
    \tl_if_blank:NF \l_pir_id_tl {}
    \tl_if_blank:NT \l_pir_id_tl {
      \msg_warning:nnn { pirouette } { missing‑id } { module }
    }
    % Render box
    \begin{tcolorbox}[enhanced,breakable,colframe=black!70,colback=gray!5,title={\bfseries \l_pir_title_tl\ — ID: \l_pir_id_tl\ (v\l_pir_ver_tl)}]
      \textbf{Type}: \l_pir_type_tl\\
      \textbf{Parents}: \l_pir_parents_tl\\
      \textbf{Children}: \l_pir_children_tl\\[2pt]
      \textbf{Provenance}: \l_pir_prov_tl\\
      \textbf{Uncertainty}: \l_pir_unc_tl\\[2pt]
      \textbf{Keywords}: \l_pir_keys_tl
    \end{tcolorbox}
  \group_end:
}
\ExplSyntaxOff

% -------------------------------------------------------------
% Back‑compat shim — warn about missing new fields
% -------------------------------------------------------------
\newcommand{\moduleClassic}[5]{%% id, title, ver, parents, children
  \PackageWarning{pirouette}{Classic module (#1) lacks provenance/uncertainty/keywords. Consider upgrading to \moduleKV.}
  \module{#1}{#2}{#3}{#4}{#5}{\textit{legacy‑import}}{—}{} }

% -------------------------------------------------------------
% Title page helper
% -------------------------------------------------------------
\newcommand{\maketitlepage}{%%
  \begin{titlepage}
    \centering
    {\Large \textsc{Pirouette Framework}\\[0.5em]}
    {\Huge \bfseries Volume~\VolumeID\\[0.5em]}
    {\LARGE \VolumeTitle\\[1em]}
    \rule{0.6\textwidth}{0.4pt}\\[1em]
    {\large Version \VolumeVersion\ (\VolumeCommit) — \VolumeDate\\[2em]}
    {\itshape \VolumeTagline}\\[4em]
    \vfill
    \small Generated via AKEP‑enabled template; subject to debate‑driven refinement.
  \end{titlepage}}


% =============================================================
%  BEGIN DOCUMENT
% =============================================================
\begin{document}
\maketitlepage

% --- Preface / Changelog ---
\section*{Preface}
This draft header seeds the \textit{Pirouette Framework} rewrite strategy agreed on 2025‑06‑28.  It establishes the minimal macro layer required to author modules in a provenance‑aware, debate‑ready style while preserving classic compatibility.  Minor edits now increment \texttt{\VolumeMinorVersion} and—if your CI injects a commit hash—\texttt{\VolumeCommit} records the precise source state.  Version 0.3 introduces the key–value 'moduleKV' interface, an optional \textbf{type} field, and deprecation warnings for classic imports.


\end{document}
